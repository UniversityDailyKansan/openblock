{% extends "base.html" %}{% comment %}<!-- -*- mode: django-html; tab-width: 4 -*- -->{% endcomment %}

{% load eb humanize mapping eb_filter comments thumbnail %}

{% block title %}{{ newsitem.title }} | {{ newsitem.schema.plural_name|capfirst }}{% endblock %}

{% block content %}

<div id="content">
<div class="row">
	<div class="twelve col" style="border-bottom:1px solid #e0e0e0; margin-bottom:20px;">
	<h1 style="font-size:28px;">{% if newsitem.schema.is_special_report %}Special report: {% endif %}{{ newsitem.title }}{% block extra_title %}{% endblock %}</h1>
	{% block newsitem_detail_summary %}{% endblock %}

    <!-- block flagging -->{% block flagging %}
	{% if allow_flagging %}

	  <div id="flag-form-wrapper"></div>
	  <script type="text/javascript">
        var formURL = '{% url moderation_flag_form newsitem.id %}';
		// Handler for receiving POST response.
		var handlePostResponse = function(html) {
			$j('#flag-form-wrapper').html(html);
			$j('#flag-submit').click(submitFlagForm);
		};

		// Handler for submitting the flag form.
		var submitFlagForm = function(evt) {
		    evt.preventDefault();
			var data = $('#flag-form').serialize();
			$j.post(formURL, data, handlePostResponse);
		};
		// Hook up the submit handler.
		var formLoaded = function(text, status, xhr) {
			$j('#flag-submit').click(submitFlagForm);
		};
		$j('#flag-form-wrapper').load(formURL, formLoaded);
	  </script>

	{% endif %}
	{% endblock flagging %}<!-- endblock flagging -->
	<div class="news_item_meta">
		<div class="row">
			<div class="twelve col">
				{% block newsitem_detail_date %}
					<!-- {{ newsitem.schema.date_name|capfirst }} -->
					<a href="{{ newsitem.item_date_url }}">{{ newsitem.item_date|date:"F j, Y" }}</a>
				{% endblock %}
				&nbsp;|&nbsp;
				
				{% if location_url %}
				<a href="{{ location_url }}">
				{% endif %}
				
				{{newsitem.location_name|default:"unknown"}}
				
				{% if location_url %}
				</a>
				
				{% endif %}
				
				{% if not newsitem.location %}
					This location couldn't be mapped.
				{% endif %}
				&nbsp;|&nbsp;
				
				{% if newsitem.url %}
					<a href="{{newsitem.url}}" style="color:#3D799E">Discover more</a>
				{% endif %}
			</div>
		</div>
		<div class="minor">
		{% block newsitem_detail_attribute_list %}
			{% for attribute in attribute_list %}
				{{ attribute.sf.smart_pretty_name|capfirst }}:
						{% if attribute.value_list %}
						{% for value in attribute.value_list %}
							{% if value.url %}
								<a href="{{ value.url }}">{{ value.value }}</a>
							{% else %}
								{{ value.value }}
							{% endif %}
							{% if value.description %}<span>{{ value.description|safe }}</span>{% endif %}&nbsp;|&nbsp;
							{% if not forloop.last %}{% if not value.description %}{% endif %}{% endif %}
						{% endfor %}
						{% else %}
						None
						{% endif %}
			{% endfor %}
		{% endblock newsitem_detail_attribute_list %}<!-- endblock: newsitem_detail_image_list..........What? -->
		</div>
			<div class="eight col" style="margin-left:0px">
		{% block newsitem_detail_description %}			
			{% if newsitem.schema.slug == "photos" %}
				{% for attribute in attribute_list %}
					{% if attribute.sf.smart_pretty_name|capfirst == "Thumbnail URL" %}
						{% for value in attribute.value_list %}
						<a href="{{ newsitem.url }}">
							<img src="{{ value.value }}" class="flickr_newsitem_thumb">
						</a>
						{% endfor %}
					{% else %}
					{% endif %}
				{% endfor %}
			{{ newsitem.description }}
			{% else %}
			<!-- For descriptions with HTML markup, see note in snippets/newsitem_list -->		
			{{ newsitem.description }}

			{% endif %}
		{% endblock %}
			<div class="clear"></div>
					<span class="st_fblike_hcount" ></span>
					<span class="st_plusone_hcount"></span>
					<span class="st_twitter_hcount"></span>
			<div class="clear"></div>
			
  {% block extracontent %}
  {% endblock %}

	<p>Retrieved on <strong>{{ newsitem.pub_date|date:"F j, Y" }}</strong>.</p>

	{% block item_comments %}
	  {% if newsitem.schema.allow_comments %}
	  {% get_comment_count for newsitem as comment_count %} 
	  <h2>{{comment_count}} Comments</h2>
	  
	  <div class="comment-list">
    {% get_comment_list for newsitem as comment_list %}
    {% for comment in comment_list %}
        <div id="c{{comment.id}}" class="comment">
          <div class="comment-text">{{ comment.comment }}</div>
          <span class="comment-author">by {{ comment.name }}</span>
          <span class="comment-date">{{comment.submit_date}}</span>
          {% comment %}<a class="comment-flag-link" href="{% url comments-flag comment.id %}">flag this comment</a>{%endcomment%}
        </div>
    {% endfor %}
    </div>

	{% comment %}
	<!-- Disqus > Django. Signup and change the shortname, replace content between item_content block with content below -->
	<div id="disqus_thread"></div>
		<script type="text/javascript">
			var disqus_shortname = 'YOUR_SHORTNAME'; // required: replace example with your forum shortname
    			var disqus_identifier = '{{ newsitem.id }}';
			var disqus_url = '{% url ebpub-homepage %}{{ newsitem.schema.url }}detail/{{ newsitem.id }}/';
    		/* * * DON'T EDIT BELOW THIS LINE * * */
    			(function() {
        			var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        			dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        			(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    			})();
		</script>
		<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
	{% endcomment %}
	
	{% block item_comments %}
    {% if request.user.is_authenticated %}
	  <h2> Add a Comment </h2>
	  {% get_comment_form for newsitem as form %}

      <form id="comment-form" action="{% comment_form_target %}" method="post">
        {% csrf_token %}
        {{form.content_type}}
        {{form.object_pk}}
        {{form.timestamp}}
        {{form.security_hash}}

        <label for="id_comment">{{form.comment.label_tag}}</label>
        <div>
          {{form.comment}}
        </div>

        <div class="hidden">
          If this field is filled in, the comment will be rejected as spam.</td>
          {{form.honeypot}}
        </div>
        
        <div>
              <input type="submit" name="submit" value="Post">
        </div>
    </form>
    {% endif %}
	  {% endif %}
	{% endblock %}
	
	<div class="four col">
		<div id="mapwrapper" style="border-bottom:1px solid #e0e0e0; margin-bottom:10px">
	  <script type="text/javascript">
	  {% autoescape off %}
	  
	  function loadMap() {
		  var config = {{map_configuration}};
      config.center = [{{map_center_x}}, {{map_center_y}}];
      config.zoom = 16;
      return new OBMap(config);        
		}
		
		{% endautoescape %}
	  </script>
	  {% include "richmaps/richmap.html" %}
	</div>

	<!-- block similaritems -->{% block similaritems %}
		{% if not newsitem.schema.is_special_report %}
			{% if locations_within %}
				<h2 style="border-top:1px solid #e0e0e0; margin-top:10px">Related</h2>
				<ul class="location_type_list" style="margin-left:20px">
					{% for location in locations_within %}
					<li><a href="{% filter_url newsitem.schema +'location' location %}">{{ location.name }}</a></li>
					{% endfor %}
					<li><a href="{{ newsitem.schema.url }}">More {{ newsitem.schema.plural_name }} in {% METRO_NAME %}</a></li>
				</ul>
			{% endif %}
		{% endif %}
	{% endblock %}<!-- endblock similaritems -->


	<h2>About {{ schema.plural_name }}...</h2>
	<ul class="inlinelist">
	  {% if newsitem.schema.summary.strip %}
	  <li>Summary: {{ newsitem.schema.summary|safe|linebreaks }}</li>
	  {% endif %}
	  {% if newsitem.schema.source.strip %}
	  {% with newsitem.schema.source.splitlines as sources %}
		<li>Source{{sources|pluralize}}:
		{% for source in sources %}
		   {% if source.strip %}
		   <a href="{{ source.strip|safe }}">{{source}}
		   </a>
		   {% endif %}
		{% endfor %}
	  {% endwith %}
	{% endif %}
	</ul>
</div>
</div><!--/ #content-->
{% endblock %}
